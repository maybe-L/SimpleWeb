{% extends 'base.html' %}

{% block extra_styles %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="csrf-token" content="{{ csrf_token() }}">

<title>CKEditor 5 - Quick start CDN</title>

<!-- CKEditor CSS 로드 -->
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.1.1/ckeditor5.css">
{% endblock %}

{% block content %}
<form id="ckeditor-form" method="POST" 
    action="{% if menu.order == 1 %}{{ url_for('main.main_menu_editor', website_url=website_data.website_url) }}{% else %}{{ url_for('main.menu_editor', website_url=website_data.website_url, menu_name=menu.name) }}{% endif %}">
    {{ form.hidden_tag() }}  <!-- CSRF 토큰을 포함하는 hidden_tag() -->

    <textarea name="content" id="editor">{{ content|safe }}</textarea>
    <input type="hidden" name="menu_id" value="{{ menu.id }}">
    <button type="submit" id="save-button">Save</button>
</form>
{% endblock %}

{% block scripts %}
<!-- CKEditor JS 파일을 로드 -->
<script src="https://cdn.ckeditor.com/ckeditor5/43.1.1/ckeditor5.umd.js"></script>

<script>
    const { ClassicEditor, Essentials, Bold, Italic, Paragraph, Font, Image, ImageToolbar, ImageCaption,
        ImageResize, ImageUpload, MediaEmbed, SimpleUploadAdapter, SourceEditing, ImageStyle } = CKEDITOR;

    let editorInstance;

    ClassicEditor
    .create(document.querySelector('#editor'), {
        plugins: [
            Essentials, Paragraph, Bold, Italic, Font, 
            Image, ImageToolbar, ImageCaption, ImageResize, ImageUpload, MediaEmbed, 
            SimpleUploadAdapter, SourceEditing, ImageStyle
        ],
        toolbar: [
            'undo', 'redo', '|',
            'bold', 'italic', '|',
            'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
            'imageUpload', 'mediaEmbed', '|',
            'sourceEditing'
        ],
        image: {
            toolbar: ['imageStyle:full', 'imageStyle:side', '|', 'imageTextAlternative'],
            styles: [
                'full', 
                'side'
            ]
        },
        simpleUpload: {
            uploadUrl: '/upload-image',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        },
        ckfinder: {
            uploadUrl: '/upload-image'
        }
    })
    .then(editor => {
        editorInstance = editor;

        document.getElementById('save-button').addEventListener('click', function(event) {
            event.preventDefault();  
            const content = editor.getData();  
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            let saveUrl = '';
            {% if menu.order == 1 %}
                saveUrl = '{{ url_for("main.main_menu_editor", website_url=website_data.website_url) }}';
            {% else %}
                saveUrl = '{{ url_for("main.menu_editor", website_url=website_data.website_url, menu_name=menu.name) }}';
            {% endif %}

            fetch(saveUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify({
                    content: content,
                    menu_id: '{{ menu.id }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Changes saved successfully!');
                } else {
                    alert('Failed to save content.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    })
    .catch(error => {
        console.error('There was a problem initializing the CKEditor:', error);
    });
</script>


{% endblock %}
